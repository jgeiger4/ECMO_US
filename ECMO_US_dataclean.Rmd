---
title: "ECMO US"
author: "Joshua Geiger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
library(janitor)
library(readxl)
library(tableone)
library(ROCR)
library(stringr)

ecmo <- read_xlsx("raw_data/VascularECMOdataset_11_5_23_mrn.xlsx",
                 na = c("", "NA", ".", "9999", "Not applicable")) %>%
  clean_names()

```

A total of `r length(unique(ecmo$e_mrn))` patients were identified since January 2013 with a total of `r nrow(ecmo)` ecmo cannulations. The dataset was filtered for patients > 18 years old who had peripheral VA - ECMO (Femoral cannulation).

##### Descriptive statistics

```{r data-cleaning, include=FALSE}

ecmo <- ecmo %>%
  mutate(sex = case_when(sex == "F" ~ "Female",
                         sex == "M" ~ "Male",
                         .default = sex),
####demographics          
         age = as.numeric(age),

#### comorbidities
        chronic_lung_disease = case_when(past_medical_history_choice_chronic_lung_disease == 1 ~ "Yes", 
                                         past_medical_history_choice_chronic_lung_disease == 0 ~ "No",
                         .default = NA),
        DM = case_when(x31_past_medical_history_choice_diabetes_mellitus_x == 1 ~ "Yes",
                       x31_past_medical_history_choice_diabetes_mellitus_x == 0 ~ "No",
                       .default = NA),
        HLD = case_when(x31_past_medical_history_choice_hyperlipidemia_x == 1 ~ "Yes",
                       x31_past_medical_history_choice_hyperlipidemia_x == 0 ~ "No",
                       .default = NA),
        shock_cause = case_when(x46_etiology_of_shock_choice_cardiac_arrest_code_x == 1 ~ "Cardiac Arrest",
                                x46_etiology_of_shock_choice_myocardial_infarction_left_x == 1 ~ "MI",
                                x46_etiology_of_shock_choice_myocardial_infarction_right_x == 1 ~ "MI",
                                x46_etiology_of_shock_choice_decompensated_nonischemic_cardiomyopathy_x == 1 ~ "NICM",
                                .default = "Other"),
#### US velocities
         sfa_distal_pvs_pre_rpc = case_when(sfa_distal_pvs_pre_rpc == "N/A" ~ NA,
                                            sfa_distal_pvs_pre_rpc == " " ~ NA,
                                            .default = sfa_distal_pvs_pre_rpc),
         sfa_distal_pvs_pre_rpc = as.numeric(sfa_distal_pvs_pre_rpc),
         sfa_distal_pvs_post_rpc = case_when(sfa_distal_pvs_post_rpc == "N/A" ~ NA,
                                            sfa_distal_pvs_post_rpc == " " ~ NA,
                                            .default = sfa_distal_pvs_post_rpc),
         sfa_distal_pvs_post_rpc = as.numeric(sfa_distal_pvs_post_rpc),
         sfa_distal_pvs = pmin(sfa_distal_pvs_pre_rpc, sfa_distal_pvs_post_rpc, na.rm = TRUE),

         ata_pvs_pre_rpc = case_when(ata_pvs_pre_rpc == "N/A" ~ NA,
                                            ata_pvs_pre_rpc == " " ~ NA,
                                            .default = ata_pvs_pre_rpc),
         ata_pvs_pre_rpc = as.numeric(ata_pvs_pre_rpc),
         ata_pvs_post_rpc = case_when(ata_pvs_post_rpc == "N/A" ~ NA,
                                            ata_pvs_post_rpc == " " ~ NA,
                                            .default = ata_pvs_post_rpc),
         ata_pvs_post_rpc = as.numeric(ata_pvs_post_rpc),
         
         pta_pvs_pre_rpc = case_when(pta_pvs_pre_rpc == "N/A" ~ NA,
                                            pta_pvs_pre_rpc == " " ~ NA,
                                            .default = pta_pvs_pre_rpc),
         pta_pvs_pre_rpc = as.numeric(pta_pvs_pre_rpc),
         pta_pvs_post_rpc = case_when(pta_pvs_post_rpc == "N/A" ~ NA,
                                            pta_pvs_post_rpc == " " ~ NA,
                                            .default = pta_pvs_post_rpc),
         pta_pvs_post_rpc = as.numeric(pta_pvs_post_rpc),
         
         tibial_pvs = pmin(ata_pvs_pre_rpc, ata_pvs_post_rpc, pta_pvs_pre_rpc,
                           pta_pvs_post_rpc,
                                      na.rm = TRUE),

         preop_abi_l = case_when(preop_abi_l == " " ~ NA,
                                 preop_abi_l == "Non-compressible" ~ "2.00",
                                 .default = preop_abi_l),
         preop_abi_l = as.numeric(preop_abi_l),
         preop_abi_r = case_when(preop_abi_r == " " ~ NA,
                                 preop_abi_r == "Non-compressible" ~ "2.00",
                                 .default = preop_abi_r),
         preop_abi_r = as.numeric(preop_abi_r),
         preop_abi_r = case_when(preop_abi_r >2.0 ~ 2.0,
                                 .default = preop_abi_r),
         preop_abi_l = case_when(preop_abi_r >2.0 ~ 2.0,
                                 .default = preop_abi_l),
 
#### outcomes
         hospital_length_of_stay = as.numeric(hospital_length_of_stay),
         amputation_yn = case_when(amputation == 1 ~ "Yes",
                                   amputation == 0 ~ "No",
                                   .default = NA),
         fasciotomy_yn = case_when(fasciotomy == 1 ~ "Yes",
                                   fasciotomy == 0 ~ "No",
                                   .default = NA),
         mortality_yn = case_when(mortality == 1 ~ "Yes",
                                   mortality == 0 ~ "No",
                                   .default = NA),
         limb_ischemia_yn = case_when(hypoperfusion_limb_ischemia == 1 ~ "Yes",
                                     hypoperfusion_limb_ischemia == 0 ~ "No",
                                     fasciotomy == 1 ~ "Yes",
                                   fasciotomy == 0 ~ "No",
                                     .default = NA),
         ischemic_comp_yn = case_when(amputation_yn == "Yes" | fasciotomy_yn == "Yes" | limb_ischemia_yn == "Yes" ~ "Yes",
                                     amputation_yn == "No" ~ "No",
                                     fasciotomy_yn == "No" ~ "No",
                                     limb_ischemia_yn == "No" ~ "No",
                                     .default = NA)) %>%
  mutate(pad_yn = case_when(pad == 1 ~ "Yes",
                           preop_abi_l < 0.9 ~ "Yes",
                           preop_abi_r < 0.9 ~ "Yes",
                           pad == 0 ~ "No",
                           .default = NA),
          distal_perfusion_cannula_ever = case_when(distal_perfusion_cannula == "Yes" ~ "Yes",
                                                      distal_perfusion_cannula == "No" ~ "No",
                                                      .default = NA),
          distal_perfusion_at_cannulation = case_when(distal_perfusion_cannula_done_at_the_time_of_initial_cannulation == "Yes" ~ "Yes",
                                                      distal_perfusion_cannula_done_at_the_time_of_initial_cannulation == "No" ~ "No",
                                                      .default = NA))


ecmo <- ecmo %>%
  mutate(femoral_cannulation = case_when(outflow_cannulation_site == "Femoral Artery" ~ 1,
                                         outflow_cannulation_site == "Aorta (Central)" ~ 0,
                                         outflow_cannulation_site == "Axillary Artery" ~ 0,
                                         initial_ecmo_mode == "V-A ECMO" ~ 1,
                                         .default = NA),
         ischemic_comp = case_when(ischemic_comp_yn == "Yes" ~ 1,
                                   ischemic_comp_yn == "No" ~ 0,
                                   .default = NA)) %>%
  filter(age >= 18 & femoral_cannulation == 1)


review <- ecmo %>%
  filter(!chart_review_date == "") %>%
  mutate(us = case_when(sfa_prox_pvs_pre_rpc >= 0 ~ 1,
                        sfa_mid_pvs_pre_rpc >= 0 ~ 1,
                        sfa_distal_pvs_pre_rpc >= 0 ~ 1,
                        pop_pvs_pre_rpc >= 0 ~ 1,
                        peroneal_pvs_pre_rpc >= 0 ~ 1,
                        ata_pvs_pre_rpc >= 0 ~ 1,
                        pta_pvs_pre_rpc >= 0 ~ 1,
                        sfa_prox_pvs_post_rpc >= 0 ~ 1,
                        sfa_mid_pvs_post_rpc >= 0 ~ 1,
                        sfa_distal_pvs_post_rpc >= 0 ~ 1,
                        pop_pvs_post_rpc >= 0 ~ 1,
                        peroneal_pvs_post_rpc >= 0 ~ 1,
                        ata_pvs_post_rpc >= 0 ~ 1,
                        pta_pvs_post_rpc >= 0 ~ 1,
                          .default = 0))
us <- review %>%
  filter(us == 1)

ecmo %>%
  select(c(starts_with("etiology_of_shock_choice"), study_record_id)) %>%
  pivot_longer(cols = starts_with("etiology_of_shock_choice"), names_to = "etiology_of_shock",
               names_prefix = "etiology_of_shock_choice_") %>%
  filter(value == 1) %>%
  right_join(ecmo)

ecmo <- ecmo %>%
  select(c(starts_with("indication_for_ecmo_choice"), study_record_id)) %>%
  pivot_longer(cols = starts_with("indication_for_ecmo_choice"), names_to = "indication_for_ecmo",
               names_prefix = "indication_for_ecmo_choice_") %>%
  filter(value == 1) %>%
  right_join(ecmo)

```

There are `r length(unique(ecmo$e_mrn))` subjects within the dataset > 18 with peripheral cannulations. Of which there were `r nrow(filter(ecmo, amputation_yn == "Yes"))` amputations and `r nrow(filter(ecmo, fasciotomy_yn == "Yes"))` fasciotomies. Of which `r length(unique(review$e_mrn))` have been chart reviewed. Of these `r sum(review$us)` had a doppler US assessment of the extremity ipsilateral to the canulation site. 

```{r tabl-1-all, echo=FALSE}
review <- review %>%
  mutate(us = as.factor(us))

CreateTableOne(vars = c("age", "sex", "COPD", "DM", "HLD", "hospital_length_of_stay",
                        "pad_yn",
                        "x38_smoking_tobacco_use_x",
                        "shock_cause",
                        "outflow_cannula_size",
                        "distal_perfusion_cannula_ever",
                        "distal_perfusion_at_cannulation",
                        "ischemic_comp_yn", "amputation_yn",
                        "fasciotomy_yn", "limb_ischemia_yn",  "mortality_yn",
                        "sfa_distal_pvs_pre_rpc", "sfa_distal_pvs_post_rpc",
                        "ata_pvs_pre_rpc", "ata_pvs_post_rpc",
                        "pta_pvs_pre_rpc", "pta_pvs_post_rpc",
                        "preop_abi_l", "preop_abi_r",
                        "sfa_distal_pvs", "tibial_pvs"), data = ecmo)

```
```{r table-1-ichemic}

CreateTableOne(vars = c("age", "sex", "COPD", "DM", "HLD", "hospital_length_of_stay",
                        "pad_yn",
                        "x38_smoking_tobacco_use_x",
                        "shock_cause",
                        "outflow_cannula_size",
                        "distal_perfusion_cannula_ever",
                        "distal_perfusion_at_cannulation",
                        "ischemic_comp_yn", "amputation_yn",
                        "fasciotomy_yn", "limb_ischemia_yn",  "mortality_yn",
                        "us",
                        
                        "sfa_prox_pvs_pre_rpc",	"sfa_mid_pvs_pre_rpc",
                        "sfa_distal_pvs_pre_rpc",	"pop_pvs_pre_rpc",
                        "peroneal_pvs_pre_rpc",	"ata_pvs_pre_rpc",
                        "pta_pvs_pre_rpc",	"contra_sfa_prox_pvs_pre_rpc",
                        "sfa_prox_pvs_post_rpc",	"sfa_mid_pvs_post_rpc",
                        "sfa_distal_pvs_post_rpc",	"pop_pvs_post_rpc",
                        "peroneal_pvs_post_rpc", "ata_pvs_post_rpc",
                        "pta_pvs_post_rpc",	"contra_sfa_prox_psv_post_rpc",
                        
                        "preop_abi_l",	"preop_abi_r",

                        "sfa_distal_pvs", "tibial_pvs"
                        ),
              strata = "limb_ischemia_yn",
              data = us)
```

```{r table-1-mortality}


CreateTableOne(vars = c("age", "sex", "COPD", "DM", "HLD", "hospital_length_of_stay",
                        "pad_yn",
                        "x38_smoking_tobacco_use_x",
                        "shock_cause",
                        "outflow_cannula_size",
                        "distal_perfusion_cannula_ever",
                        "distal_perfusion_at_cannulation",
                        "ischemic_comp_yn", "amputation_yn",
                        "fasciotomy_yn", "limb_ischemia_yn",  "mortality_yn",
                        "us",
                        
                        "sfa_prox_pvs_pre_rpc",	"sfa_mid_pvs_pre_rpc",
                        "sfa_distal_pvs_pre_rpc",	"pop_pvs_pre_rpc",
                        "peroneal_pvs_pre_rpc",	"ata_pvs_pre_rpc",
                        "pta_pvs_pre_rpc",	"contra_sfa_prox_pvs_pre_rpc",
                        "sfa_prox_pvs_post_rpc",	"sfa_mid_pvs_post_rpc",
                        "sfa_distal_pvs_post_rpc",	"pop_pvs_post_rpc",
                        "peroneal_pvs_post_rpc", "ata_pvs_post_rpc",
                        "pta_pvs_post_rpc",	"contra_sfa_prox_psv_post_rpc",
                        
                        "preop_abi_l",	"preop_abi_r",

                        "sfa_distal_pvs", "tibial_pvs"
                        ),
              strata = "mortality",
              data = us)
```


```{r distributions, echo=FALSE}

us %>%
  ggplot(aes(sfa_distal_pvs_pre_rpc)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs_post_rpc)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs)) +
  geom_histogram()
us %>%
  ggplot(aes(ata_pvs_pre_rpc)) +
  geom_histogram()
us %>%
  ggplot(aes(pta_pvs_pre_rpc)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs)) +
  geom_histogram()
us %>%
  ggplot(aes(tibial_pvs)) +
  geom_histogram()

us %>%
  ggplot(aes(preop_abi_l)) +
  geom_histogram()
us %>%
  ggplot(aes(preop_abi_r)) +
  geom_histogram()


us %>%
  ggplot(aes(sfa_distal_pvs_pre_rpc, fill = ischemic_comp_yn)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs, fill = fasciotomy_yn)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs, fill = amputation_yn)) +
  geom_histogram()
us %>%
  ggplot(aes(sfa_distal_pvs, fill = mortality_yn)) +
  geom_density()

us %>%
  ggplot(aes(tibial_pvs, fill = fasciotomy_yn)) +
  geom_histogram()
us %>%
  ggplot(aes(tibial_pvs, fill = amputation_yn)) +
  geom_histogram()
us %>%
  ggplot(aes(tibial_pvs, fill = mortality_yn)) +
  geom_density()


us %>%
  ggplot(aes(contra_sfa_prox_psv_post_rpc, fill = mortality_yn)) +
  geom_histogram(position = "dodge", identity = "stat") +
  facet_grid(mortality_yn ~ .) +
  theme_bw() +
  xlab("Contralateral SFA PSV") +
  theme(legend.position = "none")
```

```{r eval=FALSE, include=FALSE}

# Fit the logistic regression model
fit <- glm(is.numeric(ischemic_comp_yn) ~ sfa_distal_pvs, data = ecmo, family = binomial)

# Generate predictions
predictions <- predict(fit, type = "response")

# Create a prediction object
pred <- prediction(predict(fit), labels)

# Create a performance object
perf <- performance(pred, "tpr", "fpr")

# Plot the ROC curve
plot(perf)

```

